<html>
<script src="js/lib/jquery-1.9.1.min.js"></script>
<script src="js/lib/socket.io.js"></script>
<script src="js/lib/require.js"></script>
<script>
    function startup() {
        app = new View.GameApp();
        var socket = io.connect('http://' + window.location.hostname + ":3010");
        socket.on('game', function (data) {
            app.receiveMsg(new Game.ArrBuffer(data));
        })
        app.onGameStart = function () {
            app.gs.client.sendIt = function (buf) {
                if (!socket.disconnected)
                    socket.emit("orders", buf.source);
            }
        }
    }

    function addAnimations(zoom, anims) {
        for (var id in anims) {
            var anim = anims[id];
            anim.frameWidth = anim.frameWidth || zoom;
            anim.frameHeight = anim.frameHeight || zoom;
            anim.renderWidth = anim.frameWidth / zoom;
            anim.renderHeight = anim.frameHeight / zoom;
            animations[id] = anim;
        }
    }

    var resLoaded = 0, resCount = 0;
    window.resources = {}
    window.animations = {}

    var defZoom = 32;
    addAnimations(defZoom, {
        tiles: {sx:0, sy:0, sizeX: 8, sizeY: 5},
        char1: {sy:5*defZoom, sx: 0, sizeX: 4, sizeY: 4, speed: 100},
        char2: {sy:5*defZoom, sx:4*defZoom, sizeX: 1, sizeY: 4, speed: 100},
        bomb1: {sy:9*defZoom, sx:0, sizeX: 4, sizeY: 1, speed: 100},
        bomb2: {sy:9*defZoom, sx:4*defZoom, sizeX: 4, sizeY: 1, speed: 100},
        expl1: {sy:11*defZoom, sx: 0, sizeX: 4, sizeY: 1, speed: 100},
        expl2: {sy:11*defZoom, sx:4*defZoom, sizeX: 4, sizeY: 1, speed: 100}
    });

    function onLoad(err) {
        if (err)
            console.log(err);
        resLoaded++;
        if (resLoaded == resCount) {
            startup();
        }
    }

    function tryLoadImage(name, src) {
        resCount++;
        var img = new Image();
        img.onload = onLoad;
        img.src = src;
        resources[name] = img;
    }

    $(function() {
        (function() {
            var requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame ||
                    window.webkitRequestAnimationFrame || window.msRequestAnimationFrame;
            window.requestAnimationFrame = requestAnimationFrame;
        })();

        tryLoadImage("tiles", "img/tiles.png");
        resCount++;
        require(["js/Game", "js/View"], function (Game, View) {
            window.Game = Game;
            window.View = View;
            onLoad();
        });

        var keyMask = 0;
        function keyDown(key) {
            if (!app) return;
            var mask = (1<<key);
            if ((keyMask & mask) == 0) {
                keyMask ^= mask;
                app.setKeys(key);
            }
        }
        function keyUp(key) {
            if (!app) return;
            var mask = (1<<key);
            if ((keyMask & mask) != 0) {
                keyMask ^= mask;
                for (var i=1; i<=4; i++)
                    if ((keyMask & (1<<i))!=0)
                        return app.setKeys(i);
                app.setKeys(0);
            }
        }

        var docOnKeyDown = function(e) {
            var __keys = [39, 68, 38, 87, 37, 65, 40, 83, 32, 75, 17, 76, 13, 9, 80, 81, 73, 8 /* backspace */],
                    code = e.keyCode ? e.keyCode : e.which;
            switch (code) {
                case 39:
                case 68:
                    keyDown(1);
                    break;
                case 38:
                case 87:
                    keyDown(4);
                    break;
                case 37:
                case 65:
                    keyDown(3);
                    break;
                case 40:
                case 83:
                    keyDown(2);
                    break;
                case 75:
                case 32:
                    app.keyBomb();
                    break;
            }

            if (~__keys.indexOf(code)) {
                e.stopPropagation();
                e.preventDefault();
            }
        }

        var docOnKeyUp = function(e) {
            var __keys = [39, 68, 38, 87, 37, 65, 40, 83, 81, 8 /* backspace */],
                    code = e.keyCode ? e.keyCode : e.which;
            switch (code) {
                case 39:
                case 68:
                    keyUp(1);
                    break;
                case 38:
                case 87:
                    keyUp(4);
                    break;
                case 37:
                case 65:
                    keyUp(3);
                    break;
                case 40:
                case 83:
                    keyUp(2);
                    break;
            }
            if(~__keys.indexOf(code)){
                e.stopPropagation();
                e.preventDefault();
            }
        }

        $(document).on('keydown', docOnKeyDown);
        $(document).on('keyup', docOnKeyUp);

    });

</script>
<body>
<canvas id="canvas0" width="640" height="480"></canvas>
</body>
</html>